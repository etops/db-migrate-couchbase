machine:
    services:
        - docker
    node:
        version: 5.5
    pre:
        - sudo curl -L -o /usr/bin/docker 'https://s3-external-1.amazonaws.com/circle-downloads/docker-1.9.1-circleci'
        - sudo chmod 0755 /usr/bin/docker
        - git config --global user.email "dev@etops.ch"
        - git config --global user.name "devetops"
    environment:
        IMAGE_NAME: couchbase
        COUCHBASE_HOST: couchbase://localhost
        COUCHBASE_PORT: 8091

general:
    build_dir: .
    artifacts:
        - ./coverage

dependencies:
    pre:
        - docker version
        - docker info
    override:
        - docker info
        - docker pull mdavidallen/couchbase:latest

test:
    pre:
        - npm install
        - npm install -g gulp babel babel-cli db-migrate couchbase
        - docker run -d --name couchtest -p 8091:8091 -p 8092:8092 -p 8093:8093 -p 11210:11210 mdavidallen/couchbase:latest
        - sleep 10
        # Verify docker container is running.
        - curl --retry 20 --retry-delay 10 -v http://localhost:8091/index.html -C -
        # Install driver into its own node_modules, so that db-migrate can see this plugin.
        - gulp compile
        - npm link .
        - npm link db-migrate-couchbase
        - ls -l node_modules/db-migrate-couchbase/*
        - cat database.json
        # Bring DB to state 1.
        - babel-node ./create-db-state-1.js
        - ls node_modules/ ; ls node_modules/couchbase/lib
        - ./node_modules/.bin/db-migrate up --dry-run
        - ./node_modules/.bin/db-migrate up
        - ./node_modules/.bin/db-migrate down
    post:
        - docker logs --tail=200 couchtest 2>&1 | tee $CIRCLE_ARTIFACTS/docker.log
    override:
        - gulp test

deployment:
    hub:
        branch: master
        commands:
           - echo "NPM publishing"
           - echo -e "$NPM_USERNAME\n$NPM_PASSWORD\n$NPM_EMAIL" | npm login
           -  npm run 2npm
